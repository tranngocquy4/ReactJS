<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Axios</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>
    <script src="script.js"></script>
    <style>
        .mask {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgb(215, 215, 215);
            opacity: 0.5;
            z-index: 1000;
        }
        .outside-spinner {
            width: fit-content;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%,-50%);
        }
    </style>
</head>
<body>
    <div class="mask" id="mask" style="display:none">
        <div class="outside-spinner">
            <div class="spinner-border" role="status">
                <span class="sr-only"></span>
            </div>
        </div>
    </div>
    <form onsubmit="submitBook(event)">
        <div class="row">
            <div class="col">
                <input id="bookName" class="form-control" name="name" placeholder="Name"/>
            </div>
            <div class="col">
                <input id="bookAuthor" class="form-control" name="author" placeholder="Author"/>
            </div>
            <div class="col">
                <button id="submitBookButton" type="submit" class="btn btn-info">Create</button>
            </div>
        </div>
    </form>
    
    <hr>

    <form onsubmit="searchBook(event)">
        <div class="row">
            <div class="col">
                <input id="searchName" class="form-control" name="name" placeholder="Name"/>
            </div>
            <div class="col">
                <input id="searchAuthor" class="form-control" name="author" placeholder="Author"/>
            </div>
            <div class="col">
                <button type="submit" class="btn btn-info">Search</button>
            </div>
        </div>
    </form>

    <hr>

    <div>
        <select class="form-select" onchange="selectPerPage(this)">
            <option value="10">10</option>
            <option value="25">25</option>
        </select>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Author</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody id="booklist">
            
        </tbody>
    </table>

    <nav aria-label="Page navigation example">
        <ul class="pagination" id="pagination">
            
        </ul>
    </nav>
    <script>
        const booklist = document.querySelector("#booklist")
        const bookName = document.querySelector("#bookName")
        const bookAuthor = document.querySelector("#bookAuthor")
        const submitBookButton = document.querySelector("#submitBookButton")
        const mask = document.querySelector("#mask")
        var choosePage = 1
        var number = 0
        var chooseBook = null
        var data = []
        var itemsPerPage = 10
        const token = 'eyJuYW1lIjoiVHJcdTFlYTduIE5nXHUxZWNkYyBRdVx1MDBmZCAoUkoyMzA3UjEpIn0:AhzRsX2K1tKCT9csNz3Sosdhqfpvkoe03a8Ju8s9SuU'
        const APICaller = axios.create({
            baseURL: "http://api.iamdien.com:8000/book/",
            headers: {
                'Content-Type': 'application/json',
            },
            params: {
                token: token,
            }
        })

        function turnMask(open) {
            if (open) {
                mask.style.display = "block"
            } else {
                mask.style.display = "none"
            }
        }

        function callGetAPI(params={}) {
            turnMask(true)
            APICaller.get("",{params:params})
            .then(res=>{
                data = res.data.data
                number = res.data.number
                createTable()
                turnMask(false)
            })
        }
        function createTable() {
            booklist.innerHTML = "" /// data là 1 array
            for (const book of data) {
                const newTr = document.createElement("tr")
                newTr.innerHTML = `
                    <td>${book.id}</td>
                    <td>${book.name}</td>
                    <td>${book.author}</td>
                    <td>
                        <button class="btn btn-${(book.id !== chooseBook) ? 'primary' : 'secondary'}" onclick="editBook(${book.id},'${book.name}','${book.author}')">Edit</button>
                        <button class="btn btn-danger" onclick=deleteBook(${book.id})>Delete</button>
                    </td>
                `
                booklist.append(newTr)
                // append() : Chen them noi dung vao vi tri sau cung
            }
            createPagination()
        }

        callGetAPI()
    
        function submitBook(e) {
            e.preventDefault()
            const inputAll = e.target.querySelectorAll("input")
            const newBook = {}
            const error = []
            for (const input of inputAll) {
                if (input.name === "name") {
                    if (input.value === "") {
                        alert("Name không được rỗng")
                        toastr.error("Name không được rỗng","Lỗi")
                        error.push("Name không được rỗng")
                        continue
                    }
                }
                if (input.name === "author") {
                    if (input.value === "") {
                        console.log("Author không được rỗng")
                        toastr.error("Author không được rỗng","Lỗi")
                        error.push("Author không được rỗng")
                        continue
                    }
                }
                newBook[input.name] = input.value
            }
            newBook.image = ""
            if (error.length == 0) {
                turnMask(true)
                if (chooseBook === null) {
                    APICaller.post("",{"params":newBook})
                    .then(res=>{
                        data.unshift(res.data.data[0])
                        createTable()
                        turnMask(false)
                    })
                } else {
                    APICaller.patch(chooseBook.toString(),{"params":newBook})
                    .then(res=>{
                        const index = data.findIndex(item=>item.id===chooseBook)
                        data[index] = res.data.data[0]
                        createTable()
                        chooseBook = null
                        bookName.value = ""
                        bookAuthor.value = ""
                        submitBookButton.innerHTML = "Create"
                        turnMask(false)
                    })
                }
            }
        }

        function editBook(id,name,author) {
            /// nếu như đã chọn sách đó rồi, mà chọn nữa thì sẽ bỏ chọn
            if (id === chooseBook) {
                bookName.value = ""
                bookAuthor.value = ""
                submitBookButton.innerHTML = "Create"
                chooseBook = null
            }
            else {
                bookName.value = name
                bookAuthor.value = author
                submitBookButton.innerHTML = "Update"
                chooseBook = id
            }
            
            createTable()
        }

        function deleteBook(id) {
            turnMask(true)
            APICaller.delete(id.toString())
            .then(res=>{
                data = data.filter(item=>item.id !== id)
                createTable()
                turnMask(false)
            })
        }

        function searchBook(e) {
            e.preventDefault()
            const searchName = document.querySelector("#searchName")
            const searchAuthor = document.querySelector("#searchAuthor")
            choosePage = 1
            callGetAPI({
                name: searchName.value,
                author: searchAuthor.value
            })
        }

        function createPagination() {
            /// viết hàm này
            /// tạo ra các lựa chọn trang dựa vào number
            const pagination = document.querySelector("#pagination")
            const totalPages = Math.ceil(number/itemsPerPage)
            pagination.innerHTML = ""
            /// nếu có number (tổng số lượng sản phẩm) ~~> làm cách nào để tính toán ra số trang
            for (var i = 0; i < totalPages; i++) {
                const newLi = document.createElement("li")
                newLi.className = "page-item" + ((i+1 === choosePage) ? " active" : "")
                newLi.style.cursor = "pointer"
                newLi.innerHTML = `<a class="page-link" onclick="changePage(${i+1})">${i+1}</a>`
                pagination.append(newLi)
            }
        }

        function changePage(page) {
            choosePage = page
            callGetAPI({
                name: searchName.value,
                author: searchAuthor.value,
                page: choosePage,
                per_page: itemsPerPage,
            })
        }

        function selectPerPage(select) {
            choosePage = 1
            itemsPerPage = select.value
            callGetAPI({
                name: searchName.value,
                author: searchAuthor.value,
                page: choosePage,
                per_page: itemsPerPage,
            })
        }
    </script>
</body>
</html>